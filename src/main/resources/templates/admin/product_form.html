<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/common :: head(${product.id == null ? 'Thêm Sản Phẩm' : 'Sửa Sản Phẩm'})}">
</head>

<body class="bg-light">
    <nav th:replace="~{fragments/common :: navbar}"></nav>

    <div class="container mt-4" style="min-height: 70vh;">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow border-0">
                    <div class="card-header bg-primary text-white py-3">
                        <h4 class="mb-0">
                            <i th:class="${product.id == null ? 'fas fa-plus-circle me-2' : 'fas fa-edit me-2'}"></i>
                            <span th:text="${product.id == null ? 'Thêm Sản Phẩm Mới' : 'Chỉnh Sửa Sản Phẩm'}">Product Form</span>
                        </h4>
                    </div>
                    <div class="card-body p-4">
                        <!-- Error Alert -->
                        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Lỗi!</strong> <span th:text="${error}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        
                        <!-- Success Alert -->
                        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Thành công!</strong> <span th:text="${success}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        
                        <form th:action="@{/admin/product/save}" th:object="${product}" method="post"
                            enctype="multipart/form-data">
                            <input type="hidden" th:field="*{id}">
                            <input type="hidden" th:field="*{createdAt}">
                            <input type="hidden" th:field="*{sold}">

                            <div class="row">
                                <!-- Left Column -->
                                <div class="col-md-8">
                                    <h5 class="mb-3 text-primary"><i class="fas fa-info-circle me-2"></i>Thông Tin Cơ Bản</h5>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Tên sản phẩm <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" th:field="*{name}" 
                                               th:classappend="${#fields.hasErrors('name')} ? 'is-invalid'" 
                                               required placeholder="Nhập tên sản phẩm">
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Danh mục <span class="text-danger">*</span></label>
                                            <select class="form-select" th:field="*{category}" id="categorySelect" required>
                                                <option value="">-- Chọn danh mục --</option>
                                                <option th:each="cat : ${categories}" 
                                                        th:value="${cat.name}" 
                                                        th:text="${cat.name}"
                                                        th:selected="${cat.name == product.category}"
                                                        th:attr="data-subcategories=${cat.subcategories}">
                                                </option>
                                            </select>
                                            <small class="text-muted">
                                                Không tìm thấy danh mục? 
                                                <a href="/admin/categories/add" target="_blank" class="text-primary">Thêm mới</a>
                                            </small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Phân loại (Subcategory)</label>
                                            <select class="form-select" th:field="*{subcategory}" id="subcategorySelect">
                                                <option value="">-- Chọn phân loại --</option>
                                            </select>
                                            <small class="text-muted">Loại sản phẩm cụ thể (áo thun, áo polo, quần jean...)</small>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Thương hiệu</label>
                                            <input type="text" class="form-control" th:field="*{brand}" placeholder="VD: CANIFA">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Chất liệu</label>
                                            <input type="text" class="form-control" th:field="*{material}" placeholder="VD: Cotton, Polyester">
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Màu sắc</label>
                                            <input type="text" class="form-control" th:field="*{color}" placeholder="VD: Đen, Trắng, Xanh">
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Mô tả sản phẩm</label>
                                        <textarea class="form-control" th:field="*{description}" rows="4" placeholder="Nhập mô tả chi tiết sản phẩm"></textarea>
                                    </div>

                                    <h5 class="mb-3 mt-4 text-primary"><i class="fas fa-tags me-2"></i>Giá & Khuyến Mãi</h5>
                                    
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label fw-bold">Giá bán <span class="text-danger">*</span></label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" th:field="*{price}" 
                                                       th:classappend="${#fields.hasErrors('price')} ? 'is-invalid'" 
                                                       required placeholder="199000" pattern="[0-9]+">
                                                <span class="input-group-text">đ</span>
                                            </div>
                                            <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></div>
                                            <small class="text-muted">Chỉ nhập số, VD: 199000</small>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label fw-bold">Giá gốc</label>
                                            <div class="input-group">
                                                <input type="text" class="form-control" th:field="*{originalPrice}" placeholder="299000" pattern="[0-9]*">
                                                <span class="input-group-text">đ</span>
                                            </div>
                                            <small class="text-muted">Để trống nếu không có</small>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label fw-bold">Giảm giá</label>
                                            <div class="input-group">
                                                <input type="number" min="0" max="100" class="form-control" th:field="*{discountPercent}" placeholder="0">
                                                <span class="input-group-text">%</span>
                                            </div>
                                        </div>
                                    </div>

                                    <h5 class="mb-3 mt-4 text-primary"><i class="fas fa-warehouse me-2"></i>Kho & Size</h5>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Số lượng tồn kho <span class="text-danger">*</span></label>
                                            <input type="number" min="0" class="form-control" th:field="*{stock}" 
                                                   th:classappend="${#fields.hasErrors('stock')} ? 'is-invalid'" 
                                                   required placeholder="100">
                                            <div class="invalid-feedback" th:if="${#fields.hasErrors('stock')}" th:errors="*{stock}"></div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Các size có sẵn</label>
                                            <input type="text" class="form-control" th:field="*{availableSizes}" placeholder="S,M,L,XL">
                                            <small class="text-muted">Phân cách bằng dấu phẩy</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Column -->
                                <div class="col-md-4">
                                    <h5 class="mb-3 text-primary"><i class="fas fa-image me-2"></i>Hình Ảnh Chính</h5>
                                    
                                    <div class="mb-3" th:if="${product.imageUrl}">
                                        <label class="form-label fw-bold">Hình hiện tại</label>
                                        <div class="border rounded p-2 text-center bg-white">
                                            <img th:src="${product.imageUrl}" class="img-fluid rounded" style="max-height: 200px;" alt="Current product image">
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Tải hình chính lên</label>
                                        <input type="file" class="form-control" name="imageFile" accept="image/*">
                                        <small class="text-muted">Để trống nếu muốn giữ hình cũ hoặc dùng URL</small>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Hoặc nhập URL hình chính</label>
                                        <input type="text" class="form-control" th:field="*{imageUrl}" placeholder="https://example.com/image.jpg">
                                    </div>

                                    <h5 class="mb-3 mt-4 text-primary"><i class="fas fa-images me-2"></i>Hình Ảnh Phụ</h5>
                                    
                                    <div class="mb-3" th:if="${product.additionalImages != null and !product.additionalImages.isEmpty()}">
                                        <label class="form-label fw-bold">Hình phụ hiện tại</label>
                                        <div class="d-flex flex-wrap gap-2">
                                            <div th:each="img : ${product.additionalImages.split(',')}" class="border rounded p-1 text-center bg-white" style="width: 80px;">
                                                <img th:src="${img}" class="img-fluid rounded" style="max-height: 60px;" alt="Additional image">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Tải hình phụ lên (tối đa 3)</label>
                                        <input type="file" class="form-control mb-2" name="additionalImageFiles" accept="image/*" multiple>
                                        <small class="text-muted">Có thể chọn nhiều file cùng lúc</small>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Hoặc nhập URL hình phụ</label>
                                        <input type="text" class="form-control" th:field="*{additionalImages}" placeholder="url1,url2,url3">
                                        <small class="text-muted">Phân cách bằng dấu phẩy</small>
                                    </div>

                                    <h5 class="mb-3 mt-4 text-primary"><i class="fas fa-star me-2"></i>Đánh Dấu</h5>
                                    
                                    <div class="card bg-light border-0">
                                        <div class="card-body">
                                            <div class="form-check form-switch mb-3">
                                                <input class="form-check-input" type="checkbox" role="switch" th:field="*{new}" id="isNewSwitch">
                                                <label class="form-check-label fw-bold" for="isNewSwitch">
                                                    <i class="fas fa-sparkles text-success me-1"></i>Sản phẩm mới
                                                </label>
                                            </div>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" role="switch" th:field="*{bestseller}" id="bestsellerSwitch">
                                                <label class="form-check-label fw-bold" for="bestsellerSwitch">
                                                    <i class="fas fa-fire text-danger me-1"></i>Bán chạy (Bestseller)
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr class="my-4">

                            <div class="d-flex gap-2 justify-content-end">
                                <a href="/admin/dashboard" class="btn btn-outline-secondary px-4">
                                    <i class="fas fa-times me-1"></i>Hủy
                                </a>
                                <button type="submit" class="btn btn-primary px-4">
                                    <i class="fas fa-save me-1"></i>Lưu Sản Phẩm
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer th:replace="~{fragments/common :: footer}"></footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Auto-populate subcategory dropdown based on selected category
        document.addEventListener('DOMContentLoaded', function() {
            const categorySelect = document.getElementById('categorySelect');
            const subcategorySelect = document.getElementById('subcategorySelect');
            
            // Store original subcategory value for edit mode
            const originalSubcategory = subcategorySelect.getAttribute('data-original-value') || subcategorySelect.value;
            
            function updateSubcategories(preserveSelection = false) {
                const selectedOption = categorySelect.options[categorySelect.selectedIndex];
                const subcategories = selectedOption.getAttribute('data-subcategories');
                
                // Store current selection before clearing
                const currentValue = preserveSelection ? originalSubcategory : '';
                
                // Clear existing options
                subcategorySelect.innerHTML = '<option value="">-- Chọn phân loại --</option>';
                
                if (subcategories && subcategories.trim() !== '') {
                    const subArray = subcategories.split(',').map(s => s.trim()).filter(s => s !== '');
                    
                    subArray.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        
                        // Restore selection if it exists in new list
                        if (sub === currentValue) {
                            option.selected = true;
                        }
                        
                        subcategorySelect.appendChild(option);
                    });
                } else {
                    // No subcategories defined - show helper message
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Chưa có phân loại con';
                    option.disabled = true;
                    subcategorySelect.appendChild(option);
                }
            }
            
            // Update on category change (don't preserve selection)
            categorySelect.addEventListener('change', () => updateSubcategories(false));
            
            // Initial load for edit mode (preserve selection)
            if (categorySelect.value) {
                updateSubcategories(true);
            }
        });
    </script>
</body>

</html>