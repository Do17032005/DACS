<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <div th:replace="~{fragments/head :: head}"></div>
    <title>Thanh to√°n | CANIFA</title>
    <style>
        .order-item {
            display: flex;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        .order-item-img {
            width: 60px;
            height: 75px;
            border-radius: 8px;
            overflow: hidden;
        }
        .order-item-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .order-item-info {
            flex: 1;
        }
        .order-item-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .order-item-variant {
            font-size: 12px;
            color: #666;
        }
        .order-item-price {
            font-weight: 600;
            color: #DA291C;
        }
    </style>
</head>

<body>
    <div th:replace="~{fragments/header :: header}"></div>

    <div class="checkout-page">
        <!-- ... existing content remains same ... -->
        <h1>Thanh to√°n</h1>
        <form class="checkout-container" id="checkoutForm" th:action="@{/orders/place}" method="post">
            <!-- ... existing container content ... -->
            <div class="checkout-form">
                <div class="form-section">
                    <h2 class="section-title"><span class="section-number">1</span>Th√¥ng tin giao h√†ng</h2>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">H·ªç t√™n *</label><input type="text"
                                class="form-control" placeholder="Nh·∫≠p h·ªç t√™n" id="fullName" name="customerName" required></div>
                        <div class="form-group"><label class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label><input type="tel"
                                class="form-control" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" id="phone" name="customerPhone" required></div>
                    </div>
                    <div class="form-group"><label class="form-label">Email</label><input type="email"
                            class="form-control" placeholder="Nh·∫≠p email" id="email" name="customerEmail"></div>
                    <div class="form-row">
                        <div class="form-group"><label class="form-label">T·ªânh/Th√†nh ph·ªë *</label>
                            <select class="form-control" name="shippingCity" required>
                                <option value="">Ch·ªçn T·ªânh/Th√†nh ph·ªë</option>
                                <option value="TP. H·ªì Ch√≠ Minh">TP. H·ªì Ch√≠ Minh</option>
                                <option value="H√† N·ªôi">H√† N·ªôi</option>
                                <option value="ƒê√† N·∫µng">ƒê√† N·∫µng</option>
                            </select>
                        </div>
                        <div class="form-group"><label class="form-label">Qu·∫≠n/Huy·ªán *</label>
                            <select class="form-control" name="shippingDistrict">
                                <option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">ƒê·ªãa ch·ªâ chi ti·∫øt *</label><input type="text"
                            class="form-control" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng, ph∆∞·ªùng/x√£" name="shippingAddress" required></div>
                    <div class="form-group"><label class="form-label">Ghi ch√∫</label><textarea class="form-control"
                            rows="3" placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng (n·∫øu c√≥)" name="note"></textarea></div>
                </div>

                <div class="form-section">
                    <h2 class="section-title"><span class="section-number">2</span>Ph∆∞∆°ng th·ª©c thanh to√°n</h2>
                    <div class="payment-methods">
                        <label class="payment-option active"><input type="radio" name="paymentMethod" value="COD" checked><img
                                src="https://cdn-icons-png.flaticon.com/128/2331/2331970.png" class="payment-logo"
                                style="height:35px">
                            <div class="payment-info">
                                <div class="payment-name">Thanh to√°n khi nh·∫≠n h√†ng (COD)</div>
                                <div class="payment-desc">Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</div>
                            </div>
                        </label>
                        <label class="payment-option"><input type="radio" name="paymentMethod" value="VNPAY"><img
                                src="https://vnpay.vn/assets/images/logo-icon/logo-primary.svg" class="payment-logo">
                            <div class="payment-info">
                                <div class="payment-name">V√≠ VNPAY / QR Code</div>
                                <div class="payment-desc">Thanh to√°n qua v√≠ ƒëi·ªán t·ª≠ VNPAY</div>
                            </div>
                        </label>
                        <label class="payment-option"><input type="radio" name="paymentMethod" value="MOMO"><img
                                src="https://upload.wikimedia.org/wikipedia/vi/f/fe/MoMo_Logo.png" class="payment-logo">
                            <div class="payment-info">
                                <div class="payment-name">V√≠ MoMo</div>
                                <div class="payment-desc">Thanh to√°n qua v√≠ ƒëi·ªán t·ª≠ MoMo</div>
                            </div>
                        </label>
                        <label class="payment-option"><input type="radio" name="paymentMethod" value="BANK"><img
                                src="https://cdn-icons-png.flaticon.com/128/2830/2830284.png" class="payment-logo"
                                style="height:35px">
                            <div class="payment-info">
                                <div class="payment-name">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</div>
                                <div class="payment-desc">Chuy·ªÉn kho·∫£n tr·ª±c ti·∫øp qua t√†i kho·∫£n ng√¢n h√†ng</div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="order-summary">
                <h2 class="summary-title">ƒê∆°n h√†ng c·ªßa b·∫°n</h2>
                <div class="order-items" id="orderItems">
                    <div th:each="item : ${cartItems}" class="order-item">
                        <div class="order-item-img">
                            <img th:src="${item.product.imageUrl}" alt="Product">
                        </div>
                        <div class="order-item-info">
                            <div class="order-item-name" th:text="${item.product.name}">T√™n s·∫£n ph·∫©m</div>
                            <div class="order-item-variant" th:text="${item.color + ' / ' + item.size + ' x' + item.quantity}">M√†u / Size x1</div>
                        </div>
                        <div class="order-item-price" th:text="${#numbers.formatDecimal(item.subtotal, 0, 'COMMA', 0, 'POINT') + 'ƒë'}">0ƒë</div>
                    </div>
                </div>

                <!-- Voucher section -->
                <div class="voucher-section" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="voucherInput" class="form-control" placeholder="Nh·∫≠p m√£ gi·∫£m gi√°" style="flex: 1;">
                        <button type="button" onclick="applyVoucher()" class="btn" style="background: #DA291C; color: white; padding: 8px 20px; border: none; border-radius: 4px; cursor: pointer;">√Åp d·ª•ng</button>
                    </div>
                    <div id="voucherMessage" style="font-size: 13px; margin-top: 8px;"></div>
                    <input type="hidden" name="voucherCode" id="appliedVoucherCode">
                </div>

                <div class="summary-row"><span>T·∫°m t√≠nh</span><span id="subtotal" th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT') + 'ƒë'}">0ƒë</span></div>
                <div class="summary-row" id="discountRow" style="display: none; color: #DA291C;"><span>Gi·∫£m gi√°</span><span id="discountAmount">0ƒë</span></div>
                <div class="summary-row"><span>Ph√≠ v·∫≠n chuy·ªÉn</span><span>Mi·ªÖn ph√≠</span></div>
                <div class="summary-row total"><span>T·ªïng c·ªông</span><span class="value" id="total" th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT') + 'ƒë'}">0ƒë</span></div>
                <button type="submit" class="btn-place-order">üîí ƒê·∫∑t h√†ng</button>
                <p class="secure-badge">üîê Thanh to√°n an to√†n & b·∫£o m·∫≠t</p>
            </div>
        </form>
    </div>

    <div th:replace="~{fragments/footer :: footer}"></div>
    <script th:inline="javascript">
        let appliedDiscount = 0;
        const originalTotal = /*[[${totalAmount}]]*/ 0;

        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function () {
                document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('active'));
                this.classList.add('active');
            });
        });

        function applyVoucher() {
            const voucherCode = document.getElementById('voucherInput').value.trim();
            const messageDiv = document.getElementById('voucherMessage');
            
            if (!voucherCode) {
                messageDiv.innerHTML = '<span style="color: #dc3545;">‚ö†Ô∏è Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°</span>';
                return;
            }

            messageDiv.innerHTML = '<span style="color: #666;">‚è≥ ƒêang ki·ªÉm tra...</span>';

            fetch('/orders/apply-voucher', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `voucherCode=${encodeURIComponent(voucherCode)}&orderAmount=${originalTotal}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    appliedDiscount = data.discount;
                    
                    // Update UI
                    document.getElementById('discountRow').style.display = 'flex';
                    document.getElementById('discountAmount').textContent = '-' + formatCurrency(data.discount);
                    document.getElementById('total').textContent = formatCurrency(data.finalAmount);
                    document.getElementById('appliedVoucherCode').value = voucherCode;
                    
                    // Show success message with remaining usage
                    let message = `<span style="color: #28a745;">‚úì ${data.message}</span><br>`;
                    message += `<span style="color: #666; font-size: 12px;">${data.voucherTitle} - Gi·∫£m ${formatCurrency(data.discount)}</span>`;
                    
                    if (data.remainingUsage !== null) {
                        message += `<br><span style="color: #ff6b00; font-size: 12px;">‚ö° C√≤n ${data.remainingUsage} l∆∞·ª£t s·ª≠ d·ª•ng</span>`;
                    }
                    
                    messageDiv.innerHTML = message;
                    
                    // Disable input
                    document.getElementById('voucherInput').disabled = true;
                } else {
                    messageDiv.innerHTML = `<span style="color: #dc3545;">‚ö†Ô∏è ${data.message}</span>`;
                    resetVoucher();
                }
            })
            .catch(error => {
                messageDiv.innerHTML = '<span style="color: #dc3545;">‚ö†Ô∏è C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i</span>';
                console.error('Error:', error);
            });
        }

        function resetVoucher() {
            appliedDiscount = 0;
            document.getElementById('discountRow').style.display = 'none';
            document.getElementById('total').textContent = formatCurrency(originalTotal);
            document.getElementById('appliedVoucherCode').value = '';
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + 'ƒë';
        }

        // Show success/error messages
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('error')) {
            showToast(urlParams.get('error'), 'error');
        }
    </script>
</body>

</html>